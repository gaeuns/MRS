<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title} + ' - 커뮤니티 - 무비리뷰'">커뮤니티 - 무비리뷰</title>
    <link rel="stylesheet" th:href="@{/main.css}">
    <link rel="stylesheet" th:href="@{/board.css}">
    <link rel="stylesheet" th:href="@{/community-detail.css}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="logo">
            <h1><a th:href="@{/}">무비리뷰</a></h1>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a th:href="@{/}">홈</a></li>
                <li><a th:href="@{/movies}">영화</a></li>
                <li><a th:href="@{/reviews}">리뷰</a></li>
                <li><a th:href="@{/rankings}">랭킹</a></li>
                <li><a th:href="@{/community}" class="active">커뮤니티</a></li>
            </ul>
        </nav>
        <div class="user-actions">
            <div class="user-profile" th:if="${session.user != null}">
                <span th:text="${session.user.userName}">사용자</span>
                <a th:href="@{/mypage}" class="profile-link">마이페이지</a>
                <a th:href="@{/logout}" class="logout-link">로그아웃</a>
            </div>
        </div>
    </div>
</header>

<main class="board-main">
    <div class="container">
        <div class="board-header">
            <h1>커뮤니티</h1>
            <div class="breadcrumb">
                <a th:href="@{/}">홈</a> > <a th:href="@{/community}">커뮤니티</a> > <span>상세보기</span>
            </div>
        </div>

        <div class="board-content">
            <article class="post-detail">
                <header class="post-header">
                    <div class="post-category">
                        <span class="category-badge" th:text="${post.category}" th:classappend="${post.category}">자유토론</span>
                        <span th:if="${post.isNew()}" class="badge new">NEW</span>
<!--                        <span th:if="${post.isHot()}" class="badge hot">HOT</span>-->
                    </div>

                    <h1 class="post-title" th:text="${post.title}">게시글 제목</h1>

                    <div class="post-meta">
                        <div class="author-info">
<!--                            <img th:src="${post.author.profileImage != null ? post.author.profileImage : '/images/default-avatar.png'}"-->
<!--                                 th:alt="${post.user.userId}" class="author-avatar">-->
                            <div class="author-details">
                                <span class="author-name" th:text="${post.user.userId}">작성자</span>
                                <span class="post-date" th:text="${#temporals.format(post.createDate, 'yyyy년 MM월 dd일')}">2023년 06월 01일</span>
                            </div>
                        </div>
                        <div class="post-stats">
                            <span class="views" th:text="'조회 ' + ${post.viewCount}">조회 123</span>
                            <span class="likes" th:text="'추천 ' + ${post.likeCount}">추천 15</span>
                            <span class="comments" th:text="'댓글 ' + ${post.commentCount}">댓글 8</span>
                        </div>
                    </div>
                </header>

                <div class="post-content">
                    <div class="content-body" th:utext="${post.content}">
                        게시글 내용이 여기에 표시됩니다.
                    </div>
                </div>

                <!-- 추천/비추천 버튼 -->
                <div class="post-actions">
                    <div class="like-section">
                        <form th:if="${session.user != null}" th:action="@{/community/{id}/like(id=${post.id})}" method="post" style="display: inline;">
<!--                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                            <button type="submit" class="btn-like" th:classappend="${isLiked} ? 'active' : ''">
                                <span class="like-icon">👍</span>
                                <span th:text="${post.likeCount}">15</span>
                            </button>
                        </form>
                        <form th:if="${session.user != null}" th:action="@{/community/{id}/dislike(id=${post.id})}" method="post" style="display: inline;">
<!--                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> 테이블에 비추천이 없음으로 오류 나와서 임시-->
                            <button type="submit" class="btn-dislike" th:classappend="${isDisliked} ? 'active' : ''">
                                <span class="dislike-icon">👎</span>
                                <span th:text="${post.dislikeCount}">2</span>
                            </button>
                        </form>
                    </div>

                    <div class="action-buttons">
                        <!-- 작성자, 관리자만 수정/삭제 가능 -->
                        <div th:if="${session.user != null and (session.user.userId == post.user.userId or session.user.userId == 'admin')}" class="author-actions">
                            <a th:href="@{/community/{id}/edit(id=${post.id})}" class="btn btn-outline">수정</a>
                            <form th:action="@{/community/{id}/delete(id=${post.id})}" method="post" style="display: inline;">
<!--                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                                <button type="submit" class="btn btn-danger"
                                        onclick="return confirm('정말로 이 게시글을 삭제하시겠습니까?')">삭제</button>
                            </form>
                        </div>

                        <!-- 신고 버튼 (다른 사용자의 글일 때) -->
                        <div th:if="${session.user != null and (session.user.userId != post.user.userId and session.user.userId != 'admin')}">
                            <button class="btn btn-report" onclick="reportPost()">신고</button>
                        </div>
                    </div>
                </div>

                <!-- 게시글 네비게이션 -->
                <div class="post-navigation">
                    <div th:if="${prevPost != null}" class="nav-item prev">
                        <span class="nav-label">이전글</span>
                        <a th:href="@{/community/{id}(id=${prevPost.id})}" th:text="${prevPost.title}">이전 게시글 제목</a>
                    </div>
                    <div th:if="${nextPost != null}" class="nav-item next">
                        <span class="nav-label">다음글</span>
                        <a th:href="@{/community/{id}(id=${nextPost.id})}" th:text="${nextPost.title}">다음 게시글 제목</a>
                    </div>
                </div>
            </article>

            <!-- 댓글 섹션 -->
            <section class="comments-section">
                <div class="comments-header">
                    <h3>댓글 <span th:text="${post.commentCount}">8</span>개</h3>
                </div>

                <!-- 댓글 작성 폼 (로그인한 사용자만) -->
                <div th:if="${session.user != null}" class="comment-form">
                    <form th:action="@{/community/{id}/comment(id=${post.id})}" method="post">
                        <div class="comment-input-area">
<!--                            <img th:src="${session.user.profileImage != null ? session.user.profileImage : '/images/default-avatar.png'}"-->
<!--                                 th:alt="${session.user.userName}" class="commenter-avatar">오류나서 임시 조치함-->
                            <textarea name="content" placeholder="댓글을 입력하세요..." required></textarea>
                        </div>
                        <div class="comment-actions">
                            <button type="submit" class="btn btn-primary">댓글 작성</button>
                        </div>
<!--                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                    </form>
                </div>

                <!-- 로그인 안내 (비로그인 사용자) -->
                <div th:if="${session.user == null}" class="login-notice">
                    <p>댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
                </div>

                <!-- 댓글 목록 -->
                <div class="comments-list">
                    <div th:each="comment : ${comments}" class="comment-item">
                        <div class="comment-header">
<!--                            <img th:src="${comment.author.profileImage != null ? comment.author.profileImage : '/images/default-avatar.png'}"-->
<!--                                 th:alt="${comment.author.userName}" class="commenter-avatar">-->
                            <div class="commenter-info">
                                <span class="commenter-name" th:text="${comment.user.userId}">댓글 작성자</span>
                                <span class="comment-date" th:text="${#temporals.format(comment.createDate, 'yyyy.MM.dd')}">2023.06.01 15:30</span>
                            </div>
                            <div class="comment-actions">
                                <!-- 댓글 작성자만 수정/삭제 가능 -->
                                <div th:if="${session.user != null and (session.user.userId == comment.user.userId or session.user.userId == 'admin')}">
                                    <button class="btn-edit-comment" th:onclick="'editComment(' + ${comment.id} + ')'">수정</button>
                                    <form th:action="@{/community/comment/{id}/delete/{communityId}(id=${comment.id}, communityId=${post.id})}" method="post" style="display: inline;">
<!--                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                                        <button type="submit" class="btn-delete-comment"
                                                onclick="return confirm('댓글을 삭제하시겠습니까?')">삭제</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="comment-content" th:id="'commentContent' + ${comment.id}">
                            <p th:text="${comment.content}">댓글 내용</p>
                        </div>

                        <!-- 숨겨진 textarea (수정용) -->
                        <div class="editForm" th:id="'editForm' + ${comment.id}" style="display: none;">
                            <form th:action="@{/community/comment/update}" method="post" th:id="'editFormInner' + ${comment.id}">
                                <textarea name="content" th:text="${comment.content}"></textarea>
                                <input type="hidden" name="commentId" th:value="${comment.id}" />
                                <input type="hidden" name="communityId" th:value="${post.id}" />
                                <div class="editButtonGroup">
                                    <button type="submit" class="editSubmit">수정 완료</button>
                                    <button type="button" class="editCancel" th:onclick="'cancelEdit(' + ${comment.id} + ')'">취소</button>
                                </div>
                            </form>
                        </div>
                    </div>


                        <!-- 댓글이 없을 때 -->
                    <div th:if="${#lists.isEmpty(comments)}" class="empty-comments">
                        <div class="empty-icon">💬</div>
                        <p>첫 번째 댓글을 작성해보세요!</p>
                    </div>
                </div>

                <!-- 댓글 페이지네이션 -->
                <div th:if="${commentPage != null and commentPage.totalPages > 1}" class="comment-pagination">
                    <a th:if="${commentPage.hasPrevious()}"
                       th:href="@{/community/{id}(id=${post.id}, commentPage=${commentPage.number - 1})}"
                       class="page-btn">이전</a>

                    <span th:each="i : ${#numbers.sequence(0, commentPage.totalPages - 1)}"
                          th:if="${i >= commentPage.number - 2 and i <= commentPage.number + 2}"
                          th:class="${i == commentPage.number} ? 'page-btn active' : 'page-btn'">
                            <a th:href="@{/community/{id}(id=${post.id}, commentPage=${i})}" th:text="${i + 1}">1</a>
                        </span>

                    <a th:if="${commentPage.hasNext()}"
                       th:href="@{/community/{id}(id=${post.id}, commentPage=${commentPage.number + 1})}"
                       class="page-btn">다음</a>
                </div>
            </section>

            <div class="back-to-list">
                <a th:href="@{/community}" class="btn btn-secondary">목록으로</a>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; 2023 무비리뷰. All rights reserved.</p>
    </div>
</footer>

<script>
    function reportPost() {
        if (confirm('이 게시글을 신고하시겠습니까?')) {
            // 신고 처리 로직
            alert('신고가 접수되었습니다.');
        }
    }

    function editComment(commentId) {
        document.getElementById("editForm" + commentId).style.display = "block";
        document.getElementById("commentContent" + commentId).style.display = "none";
    }

    function cancelEdit(commentId) {
        document.getElementById("editForm" + commentId).style.display = "none";
        document.getElementById("commentContent" + commentId).style.display = "block";
    }

</script>
</body>
</html>