<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${review.movie.title} + ' ë¦¬ë·° - ' + ${review.user.userName} + ' - ë¬´ë¹„ë¦¬ë·°'">ì˜í™” ë¦¬ë·° - ë¬´ë¹„ë¦¬ë·°</title>
  <link rel="stylesheet" th:href="@{/main.css}">
  <link rel="stylesheet" th:href="@{/movies.css}">
  <link rel="stylesheet" th:href="@{/board.css}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<header class="site-header">
  <div class="container">
    <div class="logo">
      <h1><a th:href="@{/}">ë¬´ë¹„ë¦¬ë·°</a></h1>
    </div>
    <nav class="main-nav">
      <ul>
        <li><a th:href="@{/}">í™ˆ</a></li>
        <li><a th:href="@{/movies}">ì˜í™”</a></li>
        <li><a th:href="@{/community}">ì»¤ë®¤ë‹ˆí‹°</a></li>
        <li><a th:href="@{/notice}">ê³µì§€ì‚¬í•­</a></li>
      </ul>
    </nav>
    <div class="user-actions">
      <div class="user-profile" th:if="${session.user != null}">
        <span th:text="${session.user.userName}">ì‚¬ìš©ì</span>
        <a th:href="@{/mypage}" class="profile-link">ë§ˆì´í˜ì´ì§€</a>
        <a th:href="@{/logout}" class="logout-link">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
      <div class="auth-buttons" th:if="${session.user == null}">
        <a th:href="@{/login}" class="btn btn-login">ë¡œê·¸ì¸</a>
        <a th:href="@{/signup}" class="btn btn-register">íšŒì›ê°€ì…</a>
      </div>
    </div>
  </div>
</header>

<main class="review-detail-main">
  <div class="container">
    <!-- ë’¤ë¡œê°€ê¸° -->
    <div class="breadcrumb">
      <a th:href="@{/}">í™ˆ</a> >
      <a th:href="@{/movies}">ì˜í™”</a> >
      <a th:href="@{/movie-page/{id}(id=${movie.id})}" th:text="${review.movie.title}">ì˜í™” ì œëª©</a> >
      <span>ë¦¬ë·°</span>
    </div>

    <!-- ë¦¬ë·° ìƒì„¸ ë‚´ìš© -->
    <div class="review-detail-container">
      <!-- ì˜í™” ì •ë³´ ìš”ì•½ -->
      <div class="movie-summary-card">
        <div class="movie-summary-poster">
          <img th:src="${review.movie.posterUrl != null ? review.movie.posterUrl : '/placeholder.svg?height=300&width=200'}"
               th:alt="${review.movie.title}">
        </div>
        <div class="movie-summary-info">
          <h2 class="movie-title">
            <a th:href="@{/movies/{id}(id=${review.movie.id})}" th:text="${review.movie.title}">ì˜í™” ì œëª©</a>
          </h2>
          <p class="movie-meta">
            <span th:text="${review.movie.releaseDate}">2023</span> |
            <span th:text="${review.movie.category}">ì•¡ì…˜, ë“œë¼ë§ˆ</span> |
            <span th:text="${review.movie.runtime} + 'ë¶„'">120ë¶„</span>
          </p>
          <div class="movie-rating">
            <span class="rating-star">â˜…</span>
            <span class="rating-score" th:text="${review.movie.averageRating != null ? #numbers.formatDecimal(review.movie.averageRating, 1, 1) : 'N/A'}">8.5</span>
            <span class="rating-count" th:text="'(' + ${review.movie.reviewCount} + 'ëª…)'">( 124ëª… )</span>
          </div>
        </div>
      </div>

      <!-- ë¦¬ë·° ìƒì„¸ -->
      <div class="review-detail-content">
        <!-- ë¦¬ë·° í—¤ë” -->
        <div class="review-header">
          <div class="reviewer-info">
            <div class="reviewer-details">
              <h3 class="reviewer-name" th:if="${not review.user.withdrawal}" th:text="${review.user.userName}">ë¦¬ë·°ì–´</h3>
              <h3 class="reviewer-name" th:if="${review.user.withdrawal}" th:text="'íƒˆí‡´í•œ íšŒì›'">ë¦¬ë·°ì–´</h3>
              <div class="review-meta">
                <div class="review-rating">
                                        <span th:each="i : ${#numbers.sequence(1, 5)}"
                                              th:class="${i <= review.rating} ? 'star filled' : 'star'">â˜…</span>
                  <span class="rating-text" th:text="${review.rating} + 'ì '">5ì </span>
                </div>
                <span class="review-date" th:text="${review.createdAt}">2023ë…„ 06ì›” 01ì¼ 14:30</span>
              </div>
            </div>
          </div>

          <!-- ë¦¬ë·° ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="review-actions">
            <div th:if="${session.user != null and (session.user.userId.equals(review.user.userId) or session.user.userId.equals('admin'))}"
                 class="author-actions">
              <a th:href="@{/movies/{id}/review(id=${review.movie.id})}"
                 class="btn btn-edit">
                <span>âœï¸</span> ìˆ˜ì •
              </a>
              <a th:href="@{/movies/{movieId}/review/{reviewId}/delete(movieId=${review.movie.id}, reviewId=${review.id})}"
                 class="btn btn-delete">
              <span>ğŸ—‘ï¸</span> ì‚­ì œ
              </a>
            </div>
          </div>
        </div>

        <!-- ìŠ¤í¬ì¼ëŸ¬ ê²½ê³  -->
        <div th:if="${review.hasSpoiler}" class="spoiler-warning">
          <div class="spoiler-icon">âš ï¸</div>
          <div class="spoiler-text">
            <strong>ìŠ¤í¬ì¼ëŸ¬ ì£¼ì˜!</strong>
            <p>ì´ ë¦¬ë·°ì—ëŠ” ì˜í™”ì˜ ìŠ¤í¬ì¼ëŸ¬ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
          </div>
          <button class="btn btn-spoiler-toggle" onclick="toggleSpoiler()">
            ìŠ¤í¬ì¼ëŸ¬ ë³´ê¸°
          </button>
        </div>

        <!-- ë¦¬ë·° ë‚´ìš© -->
        <div class="review-content" th:class="${review.hasSpoiler} ? 'review-content spoiler-hidden' : 'review-content'">
          <div class="content-body">
            <p th:text="${review.description}">ë¦¬ë·° ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì˜í™”ì— ëŒ€í•œ ìƒì„¸í•œ ê°ìƒê³¼ í‰ê°€ê°€ í¬í•¨ë©ë‹ˆë‹¤.</p>
          </div>
        </div>

          <div class="review-stats">
            <div class="helpful-section" th:if="${session.user != null}">
              <!-- ë¡œê·¸ì¸ ìœ ì €ì¸ ê²½ìš° -->
              <!-- ë„ì›€ë¨ -->
              <form th:action="@{'/review/' + ${review.id} + '/like'}" method="post" style="display: inline;">
                <button type="submit" class="btn-helpful"
                        th:classappend="${userReview != null and userReview.like} ? 'active' : ''">
                  ğŸ‘ <span th:text="${review.likeCount}">0</span>
                </button>
              </form>

              <!-- ë„ì›€ì•ˆë¨ -->
              <form th:action="@{'/review/' + ${review.id} + '/dislike'}" method="post" style="display: inline;">
                <button type="submit" class="btn-unhelpful"
                        th:classappend="${userReview != null and userReview.dislike} ? 'active' : ''">
                  ğŸ‘ <span th:text="${review.dislikeCount}">0</span>
                </button>
              </form>
            </div>
            <div th:if="${session.user == null}" class="login-notice">
              <a th:href="@{/login}">ë¡œê·¸ì¸</a>í•˜ì‹œë©´ ë¦¬ë·° í‰ê°€ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

          <div class="review-info">
            <span class="view-count">ì¡°íšŒ <span th:text="${review.viewCount}">45</span>íšŒ</span>
            <span class="comment-count">ëŒ“ê¸€ <span th:text="${review.commentCount}">8</span>ê°œ</span>
          </div>
        </div>
      </div>

      <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
      <div class="comments-section">
        <div class="comments-header">
          <h3>ëŒ“ê¸€ <span th:text="${review.commentCount}">8</span>ê°œ</h3>
        </div>

        <div th:if="${session.user != null}" class="comment-form">
          <form th:action="@{/reviews/{id}/comments(id=${review.id})}" method="post">
            <div class="comment-input-area">
              <textarea name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
            </div>
            <div class="comment-actions">
              <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
            </div>
          </form>
        </div>

        <div th:if="${session.user == null}" class="login-notice">
          <p><a th:href="@{/login}">ë¡œê·¸ì¸</a>í•˜ì‹œë©´ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comments-list">
          <div th:each="comment : ${comments}" class="comment-item">

            <!-- ëŒ“ê¸€ í—¤ë” -->
            <div class="comment-header">
              <div class="commenter-info">
                <div class="commenter-details">
                  <span class="commenter-name" th:if="${comment.withdrawal != null and comment.withdrawal}" th:text="'íƒˆí‡´í•œ íšŒì›'"></span>
                  <span class="commenter-name" th:if="${comment.withdrawal != null and not comment.withdrawal}" th:text="${comment.userName}">ëŒ“ê¸€ ì‘ì„±ì</span>
                  <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}">ë‚ ì§œ</span>
                </div>
              </div>

              <div th:if="${session.user != null and (session.user.userId.equals(comment.authorUserId) or session.user.userId.equals('admin'))}"
                   class="comment-actions">
              <button type="button" onclick="editComment(this)">ìˆ˜ì •</button>

                <!-- ì‚­ì œ ë²„íŠ¼ì€ formìœ¼ë¡œ ê°ì‹¸ê³  JSë¡œ submit -->
                <form th:action="@{/review/{reviewId}/comment/{commentId}/delete(reviewId=${review.id}, commentId=${comment.id})}" method="post" style="display:inline;">
                  <button type="button" onclick="deleteComment(this)">ì‚­ì œ</button>
                </form>
              </div>
            </div>

            <!-- ëŒ“ê¸€ ë³¸ë¬¸ -->
            <div class="comment-content">
              <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
            </div>

            <!-- âœï¸ ìˆ˜ì • í¼ (ê¸°ë³¸ ìˆ¨ê¹€) -->
            <form th:action="@{/reviews/{reviewId}/comments/{commentId}/edit(reviewId=${review.id}, commentId=${comment.id})}"
                  method="post" class="edit-form" style="display:none; margin-top: 10px;">
              <input type="text" name="content" th:value="${comment.content}" required style="width: 80%;" />
              <button type="submit" class="btn btn-primary">ìˆ˜ì • ì™„ë£Œ</button>
            </form>

          </div>
        </div>

        <div th:if="${comments == null}" class="empty-comments">
          <div class="empty-icon">ğŸ’¬</div>
          <h4>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h4>
          <p>ì´ ë¦¬ë·°ì— ëŒ€í•œ ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>


        <div th:if="${commentPage != null and commentPage.totalPages > 1}" class="comment-pagination">
          <a th:if="${commentPage.hasPrevious()}"
             th:href="@{/reviews/{id}(id=${review.id}, commentPage=${commentPage.number - 1})}"
             class="page-btn">ì´ì „</a>

          <span th:each="i : ${#numbers.sequence(0, commentPage.totalPages - 1)}"
                th:if="${i >= commentPage.number - 2 and i <= commentPage.number + 2}"
                th:class="${i == commentPage.number} ? 'page-btn active' : 'page-btn'">
                            <a th:href="@{/reviews/{id}(id=${review.id}, commentPage=${i})}" th:text="${i + 1}">1</a>
                        </span>

          <a th:if="${commentPage.hasNext()}"
             th:href="@{/reviews/{id}(id=${review.id}, commentPage=${commentPage.number + 1})}"
             class="page-btn">ë‹¤ìŒ</a>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <p>&copy; 2023 ë¬´ë¹„ë¦¬ë·°. All rights reserved.</p>
  </div>
</footer>

<script>
  // ìŠ¤í¬ì¼ëŸ¬ í† ê¸€
  function toggleSpoiler() {
    const content = document.querySelector('.review-content');
    const button = document.querySelector('.btn-spoiler-toggle');

    if (content.classList.contains('spoiler-hidden')) {
      content.classList.remove('spoiler-hidden');
      button.textContent = 'ìŠ¤í¬ì¼ëŸ¬ ìˆ¨ê¸°ê¸°';
    } else {
      content.classList.add('spoiler-hidden');
      button.textContent = 'ìŠ¤í¬ì¼ëŸ¬ ë³´ê¸°';
    }
  }

  // ë„ì›€ë¨/ë„ì›€ì•ˆë¨ í† ê¸€
  function toggleHelpful() {
    // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡
    console.log('ë„ì›€ë¨ í† ê¸€');
  }

  function toggleUnhelpful() {
    // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡
    console.log('ë„ì›€ì•ˆë¨ í† ê¸€');
  }

  // ë¦¬ë·° ì‚­ì œ
  function deleteReview() {
    if (confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      // ì‚­ì œ ìš”ì²­ (AJAX ë˜ëŠ” form ì œì¶œ ê°€ëŠ¥)
      console.log('ë¦¬ë·° ì‚­ì œ');
    }
  }
  // ëŒ“ê¸€ ìˆ˜ì • í† ê¸€
  function editComment(button) {
    const commentItem = button.closest('.comment-item');
    const editForm = commentItem.querySelector('.edit-form');
    if (editForm.style.display === 'none' || editForm.style.display === '') {
      editForm.style.display = 'block';
    } else {
      editForm.style.display = 'none';
    }
  }

  // ëŒ“ê¸€ ì‚­ì œ í™•ì¸ í›„ form ì œì¶œ
  function deleteComment(button) {
    if (confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      const form = button.closest('form');
      form.submit();
    }
  }

</script>
</body>
</html>
